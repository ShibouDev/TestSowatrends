<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test</title>
  </head>
  <body>
    <table id="levelstab" class="table table-striped table-bordered">
      <tbody id="column-row"></tbody>
    </table>
    <div id="MGNT"></div>
  </body>
</html>
<script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
<script
  type="text/javascript"
  src="/js/lightweight-charts.standalone.production.js"
></script>
<script>
  const thSchema = {
    inst: (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 1);
      if (text) {
        th.innerHTML = text;
      }
      return th;
    },
    "4h": (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 1);
      if (text) {
        th.innerHTML = text;
      }
      return th;
    },
    "1w": (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 1);
      if (text) {
        th.innerHTML = text;
      }
      return th;
    },
    support: (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 2);

      if (text) {
        th.innerHTML = text;
      }

      return th;
    },
    cost: (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 1);
      if (text) {
        th.innerHTML = text;
      }
      return th;
    },
    resiss: (text) => {
      let th = document.createElement("th");
      th.setAttribute("colspan", 1);
      if (text) {
        th.innerHTML = text;
      }
      return th;
    },
  };

  function initSchema() {
    const initSchemaText = {
      inst: "Инструменты",
      "4h": "4H",
      "1w": "1W",
      support: "Поддержки",
      cost: "ЦЕНА",
      resiss: "Сопротивления",
    };

    const a = document.getElementById("levelstab");
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");
    for (const th of Object.keys(thSchema)) {
      tr.append(thSchema[th](initSchemaText[th]));
    }
    thead.append(tr);
    a.append(thead);
  }
  initSchema();

  window.onload = function () {
    const url = "https://sowatrends.ru/trades/crypto";
    fetch(`${url}`)
      .then((resp) => resp.json())
      .then((data) =>
        data.map((el) => {
          const column = document.getElementById("column-row");
          let tr = document.createElement("tr");
          const button = document.createElement("button");
          button.innerText = "4H";

          const button1 = document.createElement("button");
          button1.innerText = "1W";

          const h4 = thSchema["4h"]();
          const w1 = thSchema["1w"]();
          h4.append(button);
          w1.append(button1);

          const support = thSchema.support();
          const suppSchema = [
            { name: "supp" },
            { name: "suppprc", value: "%" },
          ];
          for (const supp of suppSchema) {
            const th = document.createElement("th");
            th.innerHTML = `${el[supp.name].toFixed(2)}${
              supp.hasOwnProperty("value") ? supp.value : ""
            }`;

            support.append(th);
          }

          const resiss = thSchema.resiss();
          const resissSchema = [
            { name: "resis" },
            { name: "resisprc", value: "%" },
          ];

          for (const resis of resissSchema) {
            const th = document.createElement("th");
            th.innerHTML = `${el[resis.name].toFixed(2)}${
              resis.hasOwnProperty("value") ? resis.value : ""
            }`;
            resiss.append(th);
          }
          tr.append(thSchema.inst(el.name));
          tr.append(h4);
          tr.append(w1);
          tr.append(support);
          tr.append(thSchema.cost(el.price));
          tr.append(resiss);
          column.append(tr);
        })
      );
  };
  $(function () {
    var toolTipWidth = 100;
    var toolTipHeight = 80;
    var toolTipMargin = 15;
    var width = 780;
    var height = 600;

    var chartMGNT = LightweightCharts.createChart(
      document.getElementById("MGNT"),
      {
        width: width,
        height: height,
        layout: {
          backgroundColor: "#edf6ff",
          textColor: "#000",
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
        priceScale: {
          borderColor: "#ccc",
        },
        timeScale: {
          borderColor: "rgba(197, 203, 206, 0.8)",
          timeVisible: true,
          secondsVisible: false,
        },
      }
    );

    chartMGNT.applyOptions({
      watermark: {
        color: "rgba(123, 33, 104, 0.4)",
        visible: true,
        text: "BTC 4h",
        fontSize: 24,
        horzAlign: "left",
        vertAlign: "bottom",
        autoScale: false,
      },
    });

    var barSeriesMGNT = chartMGNT.addCandlestickSeries({
      //thinBars: true,
      upColor: "#00ff00",
      downColor: "#ff0000",
      borderDownColor: "#000",
      borderUpColor: "#000",
      wickDownColor: "rgba(123, 33, 104, 1)",
      wickUpColor: "rgba(123, 33, 104, 1)",
    });
    const formData = new FormData();
    formData.append("s", "BTC");
    formData.append("key", "00000907000105060106");
    formData.append("tf", "4h");
    const url_graph = "https://sowatrends.ru/robots/graph?deals=crypto";
    fetch(`${url_graph}`, {
      method: "POST",
      body: formData,
    })
      .then((data) => data.json())
      .then((data) => {
        console.log(data)
        barSeriesMGNT.setData(
          data.data
        );
      });
    barSeriesMGNT.setMarkers([]);
  });
</script>
